<!DOCTYPE html>
<html lang="en" style="-webkit-app-region: drag;">
<head>
    <meta charset="UTF-8">
    <title>KeyViewer</title>
    <link rel="stylesheet" href="./style.css">
</head>
<body>
<div id="root"></div>
<div style="display: flex;">
    <div id="total"></div>
    <div id="kps">KPS</div>
</div>
<script>
    const _ = require('lodash')
    const config = require('../config.json')
    const keys = config.keys
    const active = []
    let total = 0
    let kps = 0
    let kpsMax = 0

    function update() {
        document.querySelector('#total').innerHTML = `TOTAL<br>${total}`
        document.querySelector('#kps').innerHTML = kps === 0 ? `KPS MAX<br>${kpsMax}` : `KPS<br>${kps}`
        if (config.counter) {
            for (const [, key] of Object.entries(keys)) {
                key.elem.innerHTML = `${key.label}<br><span style="font-size: 10px;">${key.cnt}</span>`
            }
        }
    }

    function addKps() {
        kps++
        if (kpsMax < kps) kpsMax = kps
        update()
        setTimeout(() => {
            kps--
            update()
        }, 1000)
    }

    for (const [idx, key] of Object.entries(keys)) {
        const elem = document.createElement('div')
        elem.classList.add('key')
        elem.innerText = key.label
        keys[idx].elem = elem
        if (config.counter) keys[idx].cnt = 0
        document.querySelector('#root').append(elem)
    }

    update()

    const ioHook = require('iohook');

    ioHook.on('keydown', event => {
        const k = keys.find(r=>r.key === event.keycode)
        if (k) {
            if (!active.find(r=>r===event.keycode)) {
                active.push(event.keycode)
                k.elem.classList.add('active')
                total++
                if (config.counter) {
                    const i = keys.indexOf(k)
                    if (i !== -1) keys[i].cnt++
                }
                addKps()
            }
        }
    })
    ioHook.on('keyup', event => {
        const k = keys.find(r=>r.key === event.keycode)
        if (k) {
            if (active.find(r=>r===event.keycode)) {
                _.remove(active, (i) => i === event.keycode)
                k.elem.classList.remove('active')
            }
        }
    })

    ioHook.start()
</script>
</body>
</html>
